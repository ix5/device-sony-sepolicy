# TODO(b/vndbinder): Remove once rild uses vendor binder
typeattribute rild binder_in_vendor_violators;


### ============================
### Services and service_manager
### ============================

# TODO(b/vndbinder): switch to vndbinder for rild
vndbinder_use(rild)

# Needed!
binder_use(rild)
# avc: granted { call } for comm="rild" scontext=u:r:rild:s0 tcontext=u:r:servicemanager:s0 tclass=binder
# avc: granted { search } for comm="servicemanager" name="attr" dev="proc" ino=26820 scontext=u:r:servicemanager:s0 tcontext=u:r:rild:s0 tclass=dir
# avc: granted { read } for comm="servicemanager" name="current" dev="proc" ino=26821 scontext=u:r:servicemanager:s0 tcontext=u:r:rild:s0 tclass=file

# Needed!
hwbinder_use(rild)
# avc: granted { call } for comm="rild" scontext=u:r:rild:s0 tcontext=u:r:hwservicemanager:s0 tclass=binder
# avc: granted { transfer } for comm="rild" scontext=u:r:rild:s0 tcontext=u:r:hwservicemanager:s0 tclass=binder
# avc: granted { transfer } for comm="rild" scontext=u:r:rild:s0 tcontext=u:r:hwservicemanager:s0 tclass=binder
# avc: granted { search } for comm="hwservicemanage" name="780" dev="proc" ino=21162 scontext=u:r:hwservicemanager:s0 tcontext=u:r:rild:s0 tclass=dir

# Needed!
# avc:  granted  { find } for service=vendor.qcom.PeripheralManager pid=700 uid=1001 scontext=u:r:rild:s0 tcontext=u:object_r:per_mgr_service:s0 tclass=service_manager
allow rild per_mgr_service:service_manager find;

# TODO: Needed?
add_hwservice(rild, vnd_qcrilhook_hwservice)
userdebug_or_eng(`
  auditallow rild vnd_qcrilhook_hwservice:hwservice_manager { add find };
  auditallow rild hidl_base_hwservice:hwservice_manager { add find };
')


### ============================
### Binder calls
### ============================

# TODO: Needed?
binder_call(rild, per_mgr)
# avc: granted { call } for comm="rild" scontext=u:r:rild:s0 tcontext=u:r:per_mgr:s0 tclass=binder
# avc: granted { transfer } for comm="rild" scontext=u:r:rild:s0 tcontext=u:r:per_mgr:s0 tclass=binder

# Needed!
# avc: denied { call } for comm="rild" scontext=u:r:rild:s0 tcontext=u:r:qcrilam_app:s0 tclass=binder
allow rild qcrilam_app:binder call;
# This is not needed, but includes the above:
#binder_call(rild, qcrilam_app);

# TODO: Needed?
binder_call(rild, vnd_qcrilhook_hwservice);
userdebug_or_eng(`
  auditallow rild vnd_qcrilhook_hwservice:binder { call transfer };
  auditallow vnd_qcrilhook_hwservice rild:binder { transfer };
')

# Needed!
binder_call(rild, secure_element);
# avc: denied { call } for scontext=u:r:secure_element:s0:c44,c260,c512,c768 tcontext=u:r:rild:s0 tclass=binder
# avc: denied { transfer } for comm="com.android.se" scontext=u:r:secure_element:s0:c44,c260,c512,c768 tcontext=u:r:rild:s0 tclass=binder
allow secure_element rild:binder call;
# binder_call(secure_element, rild)
# (not necessary, only call is needed)


### ============================
### Files
### ============================

# /data/vendor/radio/qcril.db and others
allow rild radio_vendor_data_file:dir create_dir_perms;
allow rild radio_vendor_data_file:file create_file_perms;

# odm/radio/qcril_database/qcril.db
# TODO: convert to allowxperm for ioctl
# -> get ioctl via auditd!
allow rild vendor_file:file { ioctl lock };
userdebug_or_eng(`
  auditallow rild vendor_file:file { ioctl lock };
')

allow rild qmuxd_socket:dir w_dir_perms;
allow rild qmuxd_socket:sock_file create_file_perms;
unix_socket_connect(rild, qmuxd, qmuxd)

allow rild netmgrd_socket:dir search;
unix_socket_connect(rild, netmgrd, netmgrd)

# TODO: convert to allowxperm for ioctl?
# Leave this in for now because somehow the below happens
allow rild self:socket ioctl;
#auditallow rild self:socket ioctl;
allowxperm rild self:socket ioctl msm_sock_ipc_ioctls;
# TODO: Why does this happen? 0x304 is within msm_sock_ipc_ioctls
# avc: denied { ioctl } for comm="rild" path="socket:[52646]" dev="sockfs" ino=52646 ioctlcmd=0xc304 scontext=u:r:rild:s0 tcontext=u:r:rild:s0 tclass=socket
# avc: denied { ioctl } for comm="rild" path="socket:[25459]" dev="sockfs" ino=25459 ioctlcmd=0xc302 scontext=u:r:rild:s0 tcontext=u:r:rild:s0 tclass=socket


### ===========================================================================
### Properties
### ===========================================================================

# avc: denied { set } for property=persist.vendor.radio.adb_log_on scontext=u:r:rild:s0 tcontext=u:object_r:vendor_default_prop:s0 tclass=property_service
# avc: granted { read } for path="/dev/__properties__/u:object_r:vendor_radio_prop:s0" dev="tmpfs" ino=13592 scontext=u:r:rild:s0 tcontext=u:object_r:vendor_radio_prop:s0 tclass=file
# avc: denied { open } for comm="rild" path="/dev/__properties__/u:object_r:vendor_radio_prop:s0" dev="tmpfs" ino=6661 scontext=u:r:rild:s0 tcontext=u:object_r:vendor_radio_prop:s0 tclass=file
get_prop(rild, vendor_radio_prop)
set_prop(rild, vendor_radio_prop)
# TODO: Remove once nothing uses ro.vendor.ril
# avc:  denied  { set } for property=ro.vendor.ril.svlte1x pid=687 uid=1001 gid=1001 scontext=u:r:rild:s0 tcontext=u:object_r:vendor_default_prop:s0 tclass=property_service
#get_prop(rild, radio_prop)
#set_prop(rild, radio_prop)
