# SELinux status
r_dir_file(system_app, selinuxfs)

# ExtendedSettings props
r_dir_rw_file(system_app, sysfs_graphics)
r_dir_rw_file(system_app, sysfs_pcc_profile)
set_prop(system_app, adbtcpes_prop)
set_prop(system_app, dispcal_prop)

# Needed by system "main" and others
# Different system_apps need this, independent from timekeep.c or
# TimeKeep.java, so keep it in here
# avc: granted { read } for comm="main" name="u:object_r:timekeep_prop:s0" dev="tmpfs" ino=13587 scontext=u:r:system_app:s0 tcontext=u:object_r:timekeep_prop:s0 tclass=file
set_prop(system_app, timekeep_prop)

# For android setttings
binder_call(system_app, per_mgr)
binder_call(system_app, wificond)
# avc: denied { call } for comm=4173796E635461736B202331 scontext=u:r:system_app:s0 tcontext=u:r:storaged:s0 tclass=binder
# -> storaged is not a public or vendor type, only private can access it.
dontaudit system_app storaged:binder call;
# TODO: Is this needed?
# Allow system_apps to at least find the storage manager:
allow system_app storaged_service:service_manager find;
userdebug_or_eng(`
  auditallow system_app storaged_service:service_manager find;
')
# avc: denied { call } for comm=4173796E635461736B202331 scontext=u:r:system_app:s0 tcontext=u:r:perfprofd:s0 tclass=binder
# From private/perfprofd.te:
# Only servicemanager, statsd, su and systemserver can communicate.
#neverallow { domain userdebug_or_eng(`-statsd') } perfprofd:binder call;
#neverallow perfprofd { domain userdebug_or_eng(`-servicemanager -statsd -su -system_server') }:binder call;
dontaudit system_app perfprofd:binder call;

# TODO: Find out which system_apps are using these
# avc: granted { search } for comm="SummaryLoader" name="/" dev="bpf" ino=1 scontext=u:r:system_app:s0 tcontext=u:object_r:fs_bpf:s0 tclass=dir
# avc: granted { search } for comm="ndroid.settings" name="/" dev="bpf" ino=1 scontext=u:r:system_app:s0 tcontext=u:object_r:fs_bpf:s0 tclass=dir
# TODO: Check if search is enough
# -> seems search is enough, but test on tama!
#allow system_app fs_bpf:dir search;
allow system_app fs_bpf:dir r_dir_perms;
# avc: denied { open } for comm="ndroid.settings" path="/proc/pagetypeinfo" dev="proc" ino=4026532283 scontext=u:r:system_app:s0 tcontext=u:object_r:proc_pagetypeinfo:s0 tclass=file
# avc: denied { open } for comm="pool-1-thread-1" path="/proc/pagetypeinfo" dev="proc" ino=4026532283 scontext=u:r:system_app:s0 tcontext=u:object_r:proc_pagetypeinfo:s0 tclass=file
allow system_app proc_pagetypeinfo:file r_file_perms;
# avc: granted { search } for comm="ndroid.settings" name="zram0" dev="sysfs" ino=40109 scontext=u:r:system_app:s0 tcontext=u:object_r:sysfs_zram:s0 tclass=dir
# TODO: Check if search is enough
allow system_app sysfs_zram:dir search;
# avc: denied { read } for comm="ndroid.settings" name="mm_stat" dev="sysfs" ino=40143 scontext=u:r:system_app:s0 tcontext=u:object_r:sysfs_zram:s0 tclass=file
# avc: denied { read } for comm="ndroid.settings" name="mem_used_total" dev="sysfs" ino=40137 scontext=u:r:system_app:s0 tcontext=u:object_r:sysfs_zram:s0 tclass=file
allow system_app sysfs_zram:file r_file_perms;
userdebug_or_eng(`
  # Suppres search adits:
  auditallow system_app fs_bpf:dir { open getattr read ioctl lock };
')
