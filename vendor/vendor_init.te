typeattribute vendor_init data_between_core_and_vendor_violators;

allow vendor_init {
    adb_keys_file
    audio_data_file
    bluetooth_data_file
    camera_data_file
    dhcp_data_file
    radio_vendor_data_file
    rootfs
    sensors_vendor_data_file
    system_data_file
    tombstone_data_file
    wifi_data_file
}:dir create_dir_perms;

allow vendor_init radio_vendor_data_file:file create_file_perms;
dontaudit vendor_init kernel:system module_request;

#allow vendor_init proc:file write;
# TODO: Check if this suffices
# avc: granted { write } for comm="init" path="/proc/sys/kernel/dmesg_restrict" dev="proc" ino=21185 scontext=u:r:vendor_init:s0 tcontext=u:object_r:proc_security:s0 tclass=file
allow vendor_init proc_kernel_sched:file write;
# avc: granted { write } for comm="init" path="/proc/sys/kernel/printk" dev="proc" ino=21184 scontext=u:r:vendor_init:s0 tcontext=u:object_r:proc:s0 tclass=file
allow vendor_init proc_kernel_printk:file write;

allow vendor_init proc_security:file write;
# avc: granted { read } for comm="init" name="persist" dev="rootfs" ino=13269 scontext=u:r:vendor_init:s0 tcontext=u:object_r:persist_file:s0 tclass=lnk_file
# TODO(c/772de603cae45bb479a9dc19d78daa1de4d88205)
# vendor_init: permit access to persist_file
# the init should be able to read the persist_file
# Signed-off-by: Alin Jerpelea <alin.jerpelea@sony.com>
allow vendor_init persist_file:lnk_file read;
# avc: granted { read } for comm="init" name="dsp" dev="rootfs" ino=1212 scontext=u:r:vendor_init:s0 tcontext=u:object_r:qdsp_file:s0 tclass=lnk_file
allow vendor_init qdsp_file:lnk_file read;

# Allow the vendor init process to read and write default_smp_affinity:
# avc: denied { write } for comm="init" name="default_smp_affinity" dev="proc" ino=4026531867 scontext=u:r:vendor_init:s0 tcontext=u:object_r:proc_irq:s0 tclass=file
allow vendor_init proc_irq:file w_file_perms;

# avc: granted { search } for comm="init" name="/" dev="tmpfs" ino=13499 scontext=u:r:vendor_init:s0 tcontext=u:object_r:device:s0 tclass=dir
allow vendor_init device:dir search;
allow vendor_init device:file { create write };
# TODO: From normal init, to create /config/*
# Command 'mkdir /config/usb_gadget/g1/functions/cser.dun.0' action=boot (/vendor/etc/init/init.usb.rc:66) took 0ms and failed: mkdir() failed: Permission denied
allow init configfs:file rw_file_perms;
allow init configfs:lnk_file { create unlink };

# from crosshatch:
# TODO: Check and maybe remove
# So far, not needed
allow vendor_init unlabeled:dir { getattr relabelfrom };
userdebug_or_eng(`
  auditallow vendor_init unlabeled:dir { getattr relabelfrom };
')

# avc: denied { relabelfrom } for comm="init" name="persist" dev="rootfs" ino=1245 scontext=u:r:vendor_init:s0 tcontext=u:object_r:rootfs:s0 tclass=lnk_file
# avc: granted { relabelfrom } for comm="init" name="dsp" dev="rootfs" ino=13246 scontext=u:r:vendor_init:s0 tcontext=u:object_r:rootfs:s0 tclass=lnk_file
allow vendor_init rootfs:lnk_file relabelfrom;
